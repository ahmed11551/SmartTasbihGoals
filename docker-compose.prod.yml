# Docker Compose для продакшена без локальной БД
# Использование: docker-compose -f docker-compose.prod.yml up -d

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./server:/app/server:ro
      - ./prisma:/app/prisma:ro
    environment:
      NODE_ENV: production
      # Укажите вашу внешнюю БД здесь:
      DATABASE_URL: ${DATABASE_URL}
      SESSION_SECRET: ${SESSION_SECRET:-dev-secret-key-change-in-production-min-32-chars-long}
      TEST_TOKEN: ${TEST_TOKEN:-test_token_123}
      BOT_REPLIKA_API_URL: ${BOT_REPLIKA_API_URL:-https://bot.e-replika.ru/docs}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      PORT: 5001
    ports:
      - "5001:5001"
    user: "0:0"
    command: >
      sh -c "
        echo 'Проверка подключения к базе данных...' &&
        echo 'Используется внешняя БД из DATABASE_URL' &&
        sleep 2 &&
        echo 'Исправление прав доступа...' &&
        rm -rf /app/node_modules/.prisma/client 2>/dev/null || true &&
        chown -R nodejs:nodejs /app/node_modules/.prisma 2>/dev/null || true &&
        chown -R nodejs:nodejs /app/dist 2>/dev/null || true &&
        echo 'Генерация Prisma клиента...' &&
        npx prisma generate &&
        chown -R nodejs:nodejs /app/node_modules/.prisma 2>/dev/null || true &&
        echo 'Создание схемы базы данных (без миграций)...' &&
        npx prisma db push --accept-data-loss --skip-generate &&
        chown -R nodejs:nodejs /app/node_modules/.prisma 2>/dev/null || true &&
        echo 'Запуск приложения...' &&
        cd /app &&
        echo 'Проверка файлов...' &&
        ls -la server/index.ts 2>&1 | head -1 &&
        ls -la dist/index.cjs 2>&1 | head -1 &&
        if [ -f server/index.ts ]; then
          echo '✅ server/index.ts найден - запуск через tsx...' &&
          [ -f dist/index.cjs ] && (mv dist/index.cjs dist/index.cjs.backup && echo 'Перемещен dist/index.cjs') || echo 'dist/index.cjs не найден' &&
          NODE_ENV=production PORT=5001 exec npx tsx server/index.ts
        elif [ -f dist/index.cjs ]; then
          echo '⚠️  server/index.ts не найден - запуск из dist/index.cjs...' &&
          exec node dist/index.cjs
        elif [ -f dist/server/index.cjs ]; then
          echo '⚠️  Запуск из dist/server/index.cjs...' &&
          exec node dist/server/index.cjs
        else
          echo '❌ Ошибка: точка входа не найдена' &&
          ls -la dist/ server/ 2>&1 | head -10 &&
          exit 1
        fi
      "
    restart: unless-stopped

