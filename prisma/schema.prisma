// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl-arm64-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Category {
  general
  surah
  ayah
  dua
  azkar
  names99
  salawat
  kalimat
}

enum GoalType {
  recite
  learn
}

enum GoalStatus {
  active
  completed
  archived
  paused
}

enum PrayerSegment {
  fajr
  dhuhr
  asr
  maghrib
  isha
  none
}

enum EventType {
  tap
  bulk
  repeat
  learn_mark
  goal_completed
  auto_reset
}

enum BadgeLevel {
  copper
  silver
  gold
}

enum HabitCategory {
  namaz
  quran
  dhikr
  sadaqa
  knowledge
  fasting
  etiquette
}

enum HabitDifficulty {
  easy
  medium
  advanced
}

enum RepeatType {
  never
  daily
  weekly
  monthly
  custom
}

enum Priority {
  low
  medium
  high
}

enum SubscriptionTier {
  muslim
  mutahsin
  sahibAlWaqf
}

enum Gender {
  male
  female
}

model User {
  id                  String           @id @default(uuid())
  username            String           @unique
  password            String
  subscriptionTier    SubscriptionTier @default(muslim)
  telegramId          String?
  firstName           String?
  locale              String?          // 'ru', 'en', 'ar' - —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  madhab              String?          // 'hanafi', 'shafii', 'maliki', 'hanbali' - –º–∞–∑—Ö–∞–±
  tz                  String           @default("UTC") // –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä "Europe/Moscow"
  notificationsEnabled Boolean          @default(true)
  notificationTime    String?          @default("09:00")
  notificationDays    String[]         @default(["mon", "tue", "wed", "thu", "fri", "sat", "sun"])
  favorites           Json?            @default("[]") // –ú–∞—Å—Å–∏–≤ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –∑–∏–∫—Ä–æ–≤: [{category: string, itemId: string}]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  habits              Habit[]
  tasks               Task[]
  goals               Goal[]
  sessions            Session[]
  dhikrLogs           DhikrLog[]
  dailyAzkar          DailyAzkar[]
  badges              Badge[]
  calendarEvents      CalendarEvent[]
  qazaDebt            QazaDebt?
  qazaCalendar        QazaCalendarEntry[]
  categoryStreaks     CategoryStreak[]
  notificationLogs    NotificationLog[]
  ownedGroups         Group[]             @relation("GroupOwner")
  groupMemberships    GroupMember[]       @relation("GroupMembers")
  groupGoalProgress   GroupGoalProgress[] @relation("GroupGoalProgress")

  @@index([telegramId])
}

model Habit {
  id            String        @id @default(uuid())
  userId        String
  templateId    String?
  category      HabitCategory
  subcategory   String?       // –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "knowledge" (books, alifba, tajweed)
  title         String
  description   String?
  iconName      String
  difficulty    HabitDifficulty
  repeatType    RepeatType
  repeatDays    String[]      @default([])
  repeatDates   Int[]         @default([])
  startDate     DateTime?
  endDate       DateTime?
  time          String?
  endTime       String?
  isAllDay      Boolean       @default(true)
  reminders     Json          @default("[]")
  calendarId    String?
  notes         String?
  url           String?
  linkedToTasbih Boolean      @default(false)
  targetCount   Int?
  currentStreak Int           @default(0)
  longestStreak Int           @default(0)
  completedDates String[]     @default([])
  createdAt     DateTime      @default(now())
  isActive      Boolean       @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category, subcategory]) // –ò–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
}

model Task {
  id          String    @id @default(uuid())
  userId      String
  title       String
  description String?
  dueDate     DateTime?
  dueTime     String?
  priority    Priority  @default(medium)
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  subtasks    Json      @default("[]")
  reminders   Json      @default("[]")
  createdAt   DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Goal {
  id              String     @id @default(uuid())
  userId          String
  category        Category
  itemId          String?
  goalType        GoalType
  title           String
  targetCount     Int
  currentProgress Int        @default(0)
  status          GoalStatus @default(active)
  startDate       DateTime
  endDate         DateTime?
  linkedCounterType String?
  repeatType      RepeatType @default(never)
  lastResetDate   DateTime?
  createdAt       DateTime   @default(now())
  completedAt     DateTime?

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions        Session[]
  dhikrLogs       DhikrLog[]
  notificationLogs NotificationLog[]
  qazaDebt        QazaDebt?         @relation("QazaGoal")

  @@index([userId])
  @@index([status, repeatType])
}

model Session {
  id            String        @id @default(uuid())
  userId        String
  goalId        String?
  prayerSegment PrayerSegment @default(none)
  startedAt     DateTime      @default(now())
  endedAt       DateTime?

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal      Goal?      @relation(fields: [goalId], references: [id], onDelete: SetNull)
  dhikrLogs DhikrLog[]

  @@index([userId])
}

model DhikrLog {
  id            String        @id @default(uuid())
  userId        String
  sessionId     String
  goalId        String?
  category      Category
  itemId        String?
  eventType     EventType
  delta         Int
  valueAfter    Int
  prayerSegment PrayerSegment @default(none)
  atTs          DateTime      @default(now())
  tz            String        @default("UTC")
  offlineId     String?       @default(uuid())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  goal    Goal?   @relation(fields: [goalId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sessionId])
}

model DailyAzkar {
  userId    String   @id
  dateLocal String
  fajr      Int      @default(0)
  dhuhr     Int      @default(0)
  asr       Int      @default(0)
  maghrib   Int      @default(0)
  isha      Int      @default(0)
  total     Int      @default(0)
  isComplete Boolean @default(false)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dateLocal])
  @@index([userId])
}

model Badge {
  id         String     @id @default(uuid())
  userId     String
  type       String
  title      String
  description String
  level      BadgeLevel
  icon       String
  achievedAt DateTime?
  isUnlocked Boolean    @default(false)
  progress   Int?
  target     Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CalendarEvent {
  id          String     @id @default(uuid())
  userId      String
  title       String
  location    String?
  startDate   DateTime
  startTime   String?
  endDate     DateTime
  endTime     String?
  isAllDay    Boolean    @default(true)
  repeatType  RepeatType @default(never)
  calendarId  String?
  reminders   Json       @default("[]")
  notes       String?
  url         String?
  createdAt   DateTime   @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model QazaDebt {
  id                   String   @id @default(uuid())
  userId               String   @unique
  gender               Gender
  birthDate            DateTime?  // –ü–æ–ª–Ω–∞—è –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±—É–ª—é–≥–∞
  birthYear            Int?      // –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  bulughAge            Int       @default(15)  // –í–æ–∑—Ä–∞—Å—Ç —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–∏—è (customizable)
  bulughDate           DateTime?  // –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –±—É–ª—é–≥–∞ (–ø–æ —Ö–∏–¥–∂—Ä–µ ‚Üí –≥—Ä–µ–≥–æ—Ä–∏–∞–Ω)
  prayerStartDate      DateTime?  // –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –Ω–∞–º–∞–∑–æ–≤
  prayerStartYear      Int?      // –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  todayAsStart         Boolean  @default(false)  // –ï—Å–ª–∏ —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
  madhab               String   @default("hanafi")  // –î–ª—è –≤–∞—Ä–∏–∞—Ü–∏–π (e.g., –≤–∏—Ç—Ä –≤ —à–∞—Ñ–∏–∏)
  calcVersion          String   @default("1.0.0")  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  calculationMethod    String   @default("calculator") // "manual" | "calculator"
  calculatedAt         DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // –ñ–µ–Ω—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π)
  haidDaysPerMonth     Int      @default(7)  // –î–Ω–µ–π —Ö–∞–π–¥–∞ –≤ –º–µ—Å—è—Ü
  childbirthCount      Int      @default(0)  // –ö–æ–ª-–≤–æ —Ä–æ–¥–æ–≤
  nifasDaysPerChildbirth Int    @default(40)  // –î–Ω–µ–π –Ω–∏—Ñ–∞—Å–∞ –Ω–∞ —Ä–æ–¥—ã

  // –ü–µ—Ä–∏–æ–¥—ã (—É–ª—É—á—à–µ–Ω–æ: –æ—Ç–¥–µ–ª—å–Ω—ã–µ JSON –¥–ª—è —Ç–∏–ø–æ–≤)
  haidPeriods          Json     @default("[]")  // [{startDate: Date, endDate: Date, days: Int}]
  nifasPeriods         Json     @default("[]")  // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ
  safarPeriods         Json     @default("[]")  // [{startDate: Date, endDate: Date, days: Int}]
  haydNifasPeriods     Json     @default("[]")  // –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  
  // –î–Ω–∏ –≤ –ø—É—Ç–∏ (—Å–∞—Ñ–∞—Ä) - –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  totalTravelDays      Int      @default(0)
  safarDays            Json     @default("[]")  // –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  
  // –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –¥–æ–ª–≥
  totalDays            Int      @default(0)
  excludedDays         Int      @default(0)
  effectiveDays        Int      @default(0)
  missedPrayers        Json     @default("{}")  // {fajr: Int, dhuhr: Int, asr: Int, maghrib: Int, isha: Int, witr: Int}
  safarPrayers         Json     @default("{}")  // {dhuhr_safar: Int, asr_safar: Int, isha_safar: Int}

  // –†–∞—Å—á–µ—Ç–Ω—ã–π –¥–æ–ª–≥ –ø–æ –∫–∞–∂–¥–æ–º—É –Ω–∞–º–∞–∑—É (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  fajrDebt             Int      @default(0)
  dhuhrDebt            Int      @default(0)
  asrDebt              Int      @default(0)
  maghribDebt          Int      @default(0)
  ishaDebt             Int      @default(0)
  witrDebt             Int      @default(0)
  
  // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ—Å–ø–æ–ª–Ω–µ–Ω–∏—è
  completedPrayers     Json     @default("{}")  // {fajr: Int, ...}
  lastUpdated          DateTime?
  fajrProgress         Int      @default(0)
  dhuhrProgress        Int      @default(0)
  asrProgress          Int      @default(0)
  maghribProgress      Int      @default(0)
  ishaProgress         Int      @default(0)
  witrProgress         Int      @default(0)
  
  // –°–≤—è–∑—å —Å —Ü–µ–ª—å—é
  goalId               String?  @unique

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal                 Goal?    @relation("QazaGoal", fields: [goalId], references: [id], onDelete: SetNull)

  @@index([userId])
}

model QazaCalendarEntry {
  id           String   @id @default(uuid())
  userId       String
  dateLocal    String   // YYYY-MM-DD –≤ tz –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  fajr         Boolean  @default(false)
  dhuhr        Boolean  @default(false)
  asr          Boolean  @default(false)
  maghrib      Boolean  @default(false)
  isha         Boolean  @default(false)
  witr         Boolean  @default(false)
  isDebtDay    Boolean  @default(true)  // –î–µ–Ω—å —Å –¥–æ–ª–≥–æ–º (üî¥) –∏–ª–∏ –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã–π
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dateLocal])
  @@index([userId])
}


model CategoryStreak {
  id            String   @id @default(uuid())
  userId        String
  category      String   // 'prayer', 'quran', 'dhikr'
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastActivityDate DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@index([userId])
}

model NotificationLog {
  id        String   @id @default(uuid())
  userId    String
  goalId    String?
  type      String   // 'daily_plan', 'motivation', 'badge', 'goal_completed'
  message   String   @db.Text
  sentAt    DateTime @default(now())
  success   Boolean  @default(true)
  error     String?  @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal Goal? @relation(fields: [goalId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sentAt])
}

// –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ü–µ–ª–∏ (—Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏) - —Ç–æ–ª—å–∫–æ –¥–ª—è Premium —Ç–∞—Ä–∏—Ñ–∞
model Group {
  id          String   @id @default(uuid())
  name        String
  description String?
  ownerId     String
  inviteCode  String   @unique
  isPublic    Boolean  @default(false)
  maxMembers  Int      @default(50)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner       User          @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     GroupMember[]
  goals       GroupGoal[]
  invites     GroupInvite[]

  @@index([ownerId])
  @@index([inviteCode])
}

model GroupMember {
  id        String   @id @default(uuid())
  groupId   String
  userId    String
  role      String   @default("member") // 'owner', 'admin', 'member'
  joinedAt  DateTime @default(now())

  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User     @relation("GroupMembers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

model GroupGoal {
  id              String     @id @default(uuid())
  groupId         String
  category        Category
  itemId          String?
  goalType        GoalType
  title           String
  targetCount     Int
  currentProgress Int        @default(0)
  status          GoalStatus @default(active)
  startDate       DateTime
  endDate         DateTime?
  linkedCounterType String?
  createdAt       DateTime   @default(now())
  completedAt     DateTime?

  group           Group              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  memberProgress  GroupGoalProgress[]

  @@index([groupId])
}

model GroupGoalProgress {
  id              String   @id @default(uuid())
  groupGoalId     String
  userId          String
  currentProgress Int      @default(0)
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())

  groupGoal       GroupGoal @relation(fields: [groupGoalId], references: [id], onDelete: Cascade)
  user            User      @relation("GroupGoalProgress", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupGoalId, userId])
  @@index([groupGoalId])
  @@index([userId])
}

model GroupInvite {
  id          String    @id @default(uuid())
  groupId     String
  inviteCode  String    @unique
  invitedBy   String
  expiresAt   DateTime?
  maxUses     Int       @default(1)
  currentUses Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  group       Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([inviteCode])
}

// –ö–∞—Ç–∞–ª–æ–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–¥—É–∞, –∞–∑–∫–∞—Ä—ã, —Å—É—Ä—ã –∏ —Ç.–¥.)
model Item {
  id                  String   @id @default(uuid())
  category            Category
  slug                String   @unique
  titleAr             String?
  titleRu             String?
  titleEn             String?
  transcriptionLatin  String?
  transcriptionCyrillic String?
  translation         String?  @db.Text
  audioUrl            String?
  source              String?
  benefits            String?  @db.Text
  metaJson            Json?    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: –¥–ª—è —Å—É—Ä {surah_number: 1, ayah_count: 7}, –¥–ª—è –¥—É–∞ {text: "..."}
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([category])
  @@index([slug])
}

